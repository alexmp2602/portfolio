---
// src/components/LabPreviewCard.astro
interface Props {
  title: string;
  href: string;
  description?: string;
  poster?: string;
  posterWebp?: string;
  posterAvif?: string;
}

const { title, href, description, poster, posterWebp, posterAvif } =
  Astro.props as Props;

const srcPoster =
  poster && poster.trim() !== "" ? poster : "/demos/gsap-cover.webp";
---

<article
  data-preview-card
  class="group glass-card rounded-2xl overflow-hidden card-hover"
  aria-label={`Demo: ${title}`}
  data-reveal
>
  <div
    class="relative w-full aspect-video border-t border-black/5 dark:border-white/10"
  >
    <div class="absolute right-2 top-2 z-20">
      <a
        href={href}
        target="_blank"
        rel="noopener noreferrer"
        class="btn-outline px-3 py-1.5 rounded-full text-xs md:text-sm bg-black/30 dark:bg-white/10 backdrop-blur-sm"
        aria-label={`Abrir demo ${title} en una pestaña nueva`}
      >
        Abrir demo ↗
      </a>
    </div>

    <picture data-fallback class="absolute inset-0 z-0">
      {posterAvif && <source srcset={posterAvif} type="image/avif" />}
      {posterWebp && <source srcset={posterWebp} type="image/webp" />}
      <img
        src={srcPoster}
        alt=""
        class="w-full h-full object-cover"
        loading="lazy"
        decoding="async"
        width="640"
        height="360"
      />
    </picture>

    <iframe
      data-frame
      data-src={href}
      title={title}
      loading="lazy"
      sandbox="allow-scripts allow-same-origin"
      class="w-full h-full opacity-0 transition-opacity duration-300 z-1"
    ></iframe>

    <div
      class="absolute inset-0 ring-1 ring-black/5 dark:ring-white/10 pointer-events-none z-0"
      aria-hidden="true"
    >
    </div>
  </div>

  <div class="p-6 surface-muted transition-colors duration-300">
    <h3
      class="text-lg md:text-xl font-bold text-surface transition-colors group-hover:text-primary dark:group-hover:text-accent"
    >
      {title}
    </h3>

    {
      description && (
        <p class="mt-3 text-surface-muted leading-relaxed text-balance">
          {description}
        </p>
      )
    }
  </div>

  <script is:inline>
    (() => {
      const root = document.currentScript?.closest("[data-preview-card]");
      if (!root) return;

      const frame = root.querySelector("[data-frame]");
      const fallback = root.querySelector("[data-fallback]");
      if (!(frame instanceof HTMLIFrameElement)) return;

      const reduced =
        document.documentElement.dataset.reduceMotion === "true" ||
        window.matchMedia?.("(prefers-reduced-motion: reduce)")?.matches ===
          true;

      if (reduced) return;

      const src = frame.getAttribute("data-src") || "";
      if (!src) return;

      const load = () => {
        if (!frame.src) frame.src = src;
      };

      frame.addEventListener(
        "load",
        () => {
          frame.classList.add("opacity-100");
          if (fallback instanceof HTMLElement) fallback.style.display = "none";
        },
        { once: true },
      );

      const io = new IntersectionObserver(
        (entries) => {
          if (entries[0]?.isIntersecting) {
            load();
            io.disconnect();
          }
        },
        { rootMargin: "200px 0px" },
      );

      io.observe(frame);
    })();
  </script>
</article>
